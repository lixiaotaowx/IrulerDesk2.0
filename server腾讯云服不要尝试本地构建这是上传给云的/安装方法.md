# WebSocket 服务器安装方法（路由版，防串流）

只部署路由版：`websocket_server_with_routing.cpp`（支持 `/publish/<id>`、`/subscribe/<id>`、`/login`）。

## 1) 依赖（Ubuntu/Debian）

```bash
sudo apt update
sudo apt install -y build-essential cmake pkg-config qt6-base-dev qt6-websockets-dev
```

## 2) 放行端口（必做）

- 服务器防火墙（ufw）：

```bash
sudo ufw allow 8765/tcp
sudo ufw status
```

- 腾讯云安全组入站：TCP 8765，来源按需收紧（测试可先 0.0.0.0/0）

## 3) 上传文件到服务器（同一目录）

- `websocket_server_with_routing.cpp`
- `CMakeLists.txt`
- `build.sh`
- `websocket-server.service`
- `install-service.sh`
- `update-service.sh`（可选）
- `uninstall-service.sh`（可选）

## 4) 首次安装（会安装 systemd 服务）

```bash
chmod +x build.sh install-service.sh
sudo ./install-service.sh
```

默认：
- 服务名：`websocket-server`
- 安装目录：`/opt/websocket_server_standalone`
- 日志：`sudo journalctl -u websocket-server -f`

## 5) 更新（重新编译 + 重启）

```bash
chmod +x update-service.sh
sudo ./update-service.sh
```

## 6) 快速验证

```bash
sudo systemctl status websocket-server --no-pager -l
ss -lntp | grep 8765 || netstat -lntp | grep 8765
```

## 7) 客户端连接格式（必须）

- 推流端：`ws://<ip-or-domain>:8765/publish/<deviceId>`
- 拉流端：`ws://<ip-or-domain>:8765/subscribe/<deviceId>`
- 登录：`ws://<ip-or-domain>:8765/login`
