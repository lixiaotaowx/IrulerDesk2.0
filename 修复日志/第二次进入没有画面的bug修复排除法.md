# Bug 修复排除记录

## 1. 解码器状态重置 (Decoder Reset) - 排除
**尝试操作**：在 `recreateReceiver` 中强制销毁并重新创建 `m_decoder` (DxvaVP9Decoder) 实例。
**结果**：无效。第二次进入依然黑屏。
**结论**：并非单纯的解码器内部状态残留导致，或者单纯重置解码器不足以解决问题（可能配合了其他问题，如未收到关键帧）。

## 2. 清理服务器端状态 (Server-Side State Cleanup) - 排除
**尝试操作**：在 `stopReceiving` 中，在断开 WebSocket 连接前显式调用 `sendStopStreaming()`。
**结果**：无效。第二次进入依然黑屏。
**结论**：服务器端并未因为缺少停止指令而拒绝新的推流，或者发送指令的时机/方式未能成功重置服务器状态。

## 3. 延迟发送观看请求 (Delayed Watch Request) - 排除
**尝试操作**：在 `recreateReceiver` 的 `connected` 信号中，移除密集的重试请求，改为连接成功后立即请求一次，若2秒无数据则再次请求。
**结果**：无效。第二次进入依然黑屏。
**结论**：并非因为请求过于频繁导致服务器忽略，延迟请求并未解决问题。

## 4. 强制重建接收器 (Force Recreate Receiver) - 部分有效
**尝试操作**：在 `startReceiving` 中，无论当前状态如何，都强制销毁并重新创建 `WebSocketReceiver` 实例。
**结果**：情况有所改善。有时可以秒开，但有时依然会出现黑屏，等待时间长达5秒以上。
**结论**：状态残留是原因之一，但并非全部。秒开证明连接建立和解码器初始化没有根本性问题。偶尔的5秒延迟强烈暗示了**关键帧缺失**（Keyframe Missing）的问题。如果初始的关键帧请求被忽略或丢失，客户端必须等待服务器发送下一个周期性的关键帧（通常GOP设置就在几秒左右），导致黑屏等待。

## 5. 激进的关键帧请求策略 (Aggressive Keyframe Request) - 排除
**分析**：针对第4步中出现的“偶尔黑屏5秒”现象，推测是由于初始 `sendRequestKeyFrame` 发送过早（连接未完全就绪）或被丢包，导致客户端必须等待下一个I帧。
**尝试操作**：在连接建立后，采用“激进”策略请求关键帧。除了连接时立即请求外，启动一个短定时器（500ms, 1500ms），如果检测到尚未收到任何视频帧，则再次发送关键帧请求。
**结果**：无效。用户反馈修改没有任何作用，有时候依然会黑屏等待5秒以上。
**结论**：单纯增加请求频率无效。这表明问题不在于请求发送的次数，而在于服务端是否真的生成并发出了关键帧。

## 6. 调整请求时序与延迟 (Request Timing & Delays) - 排除
**分析**：Fix 5无效表明并行或快速连续发送`Watch`和`Keyframe`请求可能导致问题。
**尝试操作**：修改客户端逻辑，仅在收到 `streaming_ok` 信号后才发送关键帧请求。
**结果**：无效。用户反馈没有任何作用。
**结论**：时序调整并未解决问题。这进一步证实问题出在服务端。

## 7. 修正静态帧跳过逻辑 (Fix Static Frame Skip Logic) - 进行中
**分析**：深入分析服务端代码 `VP9Encoder.cpp` 发现，为了节省流量，编码器启用了“静态帧跳过”功能（Static Frame Skipping）。当画面静止时，`encode` 函数会直接返回空数据，根本不进行编码。
虽然 `WebSocketSender` 收到了 `request_keyframe` 并调用了 `encoder->forceKeyFrame()` 设置了 `m_forceNextKeyFrame = true`，但在 `encode` 函数中，**静态检测的判断先于强制关键帧的判断**。
导致的结果是：如果新观众进入时，屏幕内容正好是静止的（这很常见），编码器会判定为“静态”，直接丢弃该帧，从而忽略了“强制关键帧”的请求。直到屏幕发生变化（变为动态），编码器才会继续工作，此时 `m_forceNextKeyFrame` 依然有效，关键帧才会被发送。这就解释了为什么“有时候秒开（刚好屏幕在动），有时候黑屏很久（屏幕静止直到用户操作）”。
**计划操作**：修改 `VP9Encoder.cpp`，在判断是否跳过静态帧时，增加 `&& !m_forceNextKeyFrame` 条件。确保当有强制关键帧请求时，即使画面静止，也必须进行编码并发送。
