# 彻底修复局域网视频传输（分步稳妥推进）

目标：同一局域网内优先稳定走 LAN（8766）。公网/云（8765）只作为老版本兜底，不作为“判断谁在同一局域网”的来源。

这份步骤按“先把 LAN relay 跑稳 → 再用 UDP 广播发现同网段与地址 → 再做 WS 握手确认与直连 → 最后保留云兜底（老版本）”的顺序推进，每一步都能独立验证，出问题也容易定位。

---

## Step 0：准备与配置（不改代码）

1. 确认两端（观看端、被观看端）都能读取到同一份配置文件
   - 读取路径顺序见：[AppConfig.h](file:///g:/c/2025/lunzi/IrulerDeskpro/src/common/AppConfig.h)
   - 常用位置：`<程序目录>/config/app_config.txt`

2. 在 `app_config.txt` 里确认这些配置（推荐先固定端口，别搞端口随 ID 变化）
   - `lan_ws_enabled=1`
   - `lan_ws_port=8766`
   - （可选）只调试 LAN：`lan_only=1` 或 `lan_only_enabled=1`

3. 防火墙/杀软注意事项
   - LAN 端口是 8766；若被 Windows 防火墙拦，现象通常是：云能看，LAN 永远探测失败。
   - 不要用“能 ping 通”作为结论；以“能 WS 连上 + 能收到视频关键帧”为准。

验证要点（你运行后复制日志即可）：
- 被观看端出现：`[LanRelay] started  port= 8766`
- 观看端能看到同网段发现/握手成功（后续会在 Step 2/3 定义日志关键字）

---

## Step 1：确保被观看端 LAN WS 服务稳定启动（8766）

目的：确认 LAN relay 服务端确实在被观看端启动并监听 8766，否则任何 LAN 切换都会失败。

实现位置：
- 被观看端（采集进程）启动 LAN relay：  
  [main_capture.cpp](file:///g:/c/2025/lunzi/IrulerDeskpro/src/capture/main_capture.cpp)
  - `LanRelayServer::start(port)` 监听 `AnyIPv4:lan_ws_port`

验证方法（只看日志）：
- 启动被观看端后，日志必须出现：
  - `[LanRelay] started  port= 8766`
  - 若失败会有：`[LanRelay] start_failed ...`

失败常见原因与处理顺序：
1) 端口被占用 → 改端口或杀掉占用进程  
2) 权限/防火墙拦截 → 放行程序或放行 8766 入站  
3) `lan_ws_enabled=0` 或配置没被读到 → 检查配置路径与键名

---

## Step 2：UDP 广播发现同局域网设备（核心）

目的：上线后快速知道“谁在同一个局域网，以及应该连哪个地址”，不依赖公网/云端下发 IP。

基本机制：
1. 每台机器启动 LAN WS 服务（固定端口 8766，见 Step 1）
2. 每隔 2–5 秒（带随机抖动，避免同步脉冲）发送 UDP 广播包
3. 广播包内容建议：`{user_id, device_id, ws_port, ts, nonce, sig}`
4. 接收端以 UDP 源 IP 作为对方 LAN IP，拼出候选 endpoint：`ws://<source_ip>:<ws_port>`

关键点（为什么这么做）：
- UDP 广播用来“发现”，WS 用来“确认与传输”。广播不承载视频。
- 不需要在 payload 里硬塞“我的 LAN IP”；接收端用 source IP 更可信。
- `sig` 至少要做到“只有登录态/合法设备才能生成”，防止同网段伪造广播。

验证要点（你复制日志，关键是能对应一对一）：
- “收到广播”：`udp_discovery_rx user_id=... from_ip=... port=...`
- “加入候选表”：`udp_discovery_peer_up user_id=... endpoint=ws://...:8766`
- “超时离线”：`udp_discovery_peer_down user_id=... last_seen_ms=...`

推荐参数（先稳再快）：
- 广播间隔：`2s + rand(0..1s)`；稳定后可降到 `5s + rand(0..3s)`
- peer 过期：`last_seen > 8s` 视为 down
- 握手限速：同一 peer 在 `3–10s` 内失败不重复猛连

---

## Step 3：WS hello/handshake 确认可达后再走视频（核心）

目的：UDP 只能说明“对方在线且在同网段”。真正要走视频，必须用 WS 做握手确认对方服务可达、身份合法、并能拉到首帧/关键帧。

建议流程：
1. 收到广播后，用 `ws://<source_ip>:8766` 发起 WS 连接
2. 发送 `hello/handshake`（必须带 token/签名，校验 user_id/device_id）
3. 握手成功后，把 `user_id -> lan_endpoint` 标记为 `LAN_OK`（有有效期）
4. 真正开始观看时，直接连这个 endpoint 拉视频

验证要点（你复制日志）：
- `lan_ws_connect_try user_id=... endpoint=...`
- `lan_ws_handshake_ok user_id=...`
- `lan_ws_handshake_fail user_id=... reason=...`
- 视频成功：`first_frame_ok` 或 `promote_to_lan on keyframe`

如果你仍然保留“云在旁边不断”的 make-before-break：
- LAN 探测期间云连接不断，等 LAN 真正拉到首帧/关键帧再切主连接，避免黑屏。
- 这个策略与 UDP 发现并不冲突：UDP 只负责快速找到候选地址。

---

## Step 4：实时状态表（避免观看动作里反复试 LAN）

目的：观看动作“秒决策”。能走 LAN 就直接走，不能就立刻走老版本兜底；同时后台继续刷新发现状态。

推荐最小状态表（内存即可）：
- `user_id -> {last_seen_ms, last_lan_ok_ms, last_lan_fail_ms, endpoint, state}`
  - `state`：`LAN_OK / LAN_FAIL / UNKNOWN`
  - `LAN_OK` 有效期：10s（比如 10s 内直接选 LAN）
  - `LAN_FAIL` 冷却：5–15s（冷却内观看动作不再尝试 LAN）

---

## Step 5：LAN-only 模式（只要可能就死磕 LAN，不回老版本兜底）

目的：你当前“唯一目标：先打通局域网传输”。这个模式下的核心是：
- 局域网能通就只走 LAN
- LAN 掉线后优先自重连 LAN，不自动回老版本兜底

配置：
- `lan_only=1` 或 `lan_only_enabled=1`

已做的行为（检查点）：
- 兼容 `lan_only` 与 `lan_only_enabled` 两个键名  
  [AppConfig.h](file:///g:/c/2025/lunzi/IrulerDeskpro/src/common/AppConfig.h)
- LAN-only 下 LAN 探测失败会继续重试，不进入长冷却窗口  
  [WebSocketReceiver.cpp](file:///g:/c/2025/lunzi/IrulerDeskpro/src/player/WebSocketReceiver.cpp)
- LAN-only 下已切到 LAN 后断线，不自动 fallback 回公网（转为对 LAN 自重连）  
  [WebSocketReceiver.cpp](file:///g:/c/2025/lunzi/IrulerDeskpro/src/player/WebSocketReceiver.cpp)

验证要点（你复制日志）：
- 观看端选路长期为 `:8766`
- 即使 LAN 抖动断线，重连目标仍是 `:8766`，不自动回 `:8765`

---

## Step 6：老版本兜底（公网/云，可选）

什么时候用：
- UDP 发现不到同网段设备（VLAN/访客网/客户端隔离/防火墙）
- LAN WS 被策略拦截或端口不可达

兜底策略：
- 观看动作直接走老版本云端链路（例如 8765），不要在 UI 行为里反复折腾 LAN
- 后台仍继续 UDP 发现，一旦发现并握手 OK，状态表会自动把路由切回 LAN（如果你允许）

如果你仍希望保留“云下发 LAN 候选（base_urls）”作为补强：
- 可以作为 UDP 发现失败时的第二条发现路径
- 但它不等价于“判断同一局域网”，最终仍以 LAN 直连握手成功为准

---

## 你需要给我的最小反馈（你跑，我只看你复制的日志）

每次问题复现时，只要复制这些行附近即可：
- 被观看端：`[LanRelay] started` 或 `start_failed`
- 观看端：
  - `udp_discovery_rx` / `udp_discovery_peer_up` / `udp_discovery_peer_down`
  - `lan_ws_connect_try` / `lan_ws_handshake_ok` / `lan_ws_handshake_fail`
  - 视频成功：`first_frame_ok` 或 `promote_to_lan on keyframe`
  - 超时/断开：`*_timeout` / `*_disconnected`

用这几类日志就能把问题稳定归类成三种之一：
1) 没发现：UDP 收不到（VLAN/隔离/防火墙/广播策略）
2) 不可达：WS 连不上 8766（端口/防火墙/路由）
3) 可达但无首帧：WS 连上但视频关键帧/首帧收不到（转发/编码/协议层问题）
