# 项目问题汇总与优化建议 (2025-12-12)

基于对 `IrulerDeskpro` 项目代码的分析，以下是关于架构、稳定性、性能及用户体验方面的潜在风险与改进建议。

## 1. 核心传输架构风险

### 1.1 WebSocket (TCP) 传输视频流的局限性
*   **当前问题**：目前项目使用 WebSocket 传输实时音视频流。WebSocket 基于 TCP 协议，TCP 具有“可靠传输”特性，丢包时会强制重传，导致**队头阻塞 (Head-of-Line Blocking)**。
*   **后果**：在弱网环境（丢包率 > 2%）下，视频画面会发生严重的卡顿、延迟累积，甚至几秒钟的停滞，无法满足实时互动的需求。
*   **建议**：
    *   **短期**：在应用层实现丢帧策略，当发送队列过长时，主动丢弃非关键帧（P帧），只发送关键帧（I帧）。
    *   **长期**：迁移至 **WebRTC** 或基于 **UDP** 的私有协议（如 KCP, SRT）。UDP 允许少量丢包，能换取更低的延迟和流畅度。

### 1.2 明文传输的安全隐患
*   **当前问题**：连接地址使用 `ws://`，所有视频数据、音频通话、鼠标控制指令均为明文传输。
*   **后果**：在公共 WiFi 下极易被抓包窃取屏幕内容，或被中间人攻击篡改控制指令。
*   **建议**：全线升级为 `wss://` (TLS/SSL) 加密传输。

## 2. 音视频性能与体验

### 2.1 VP9 软件编码的性能瓶颈
*   **当前问题**：项目使用 `libvpx` 进行 VP9 **软件编码**。VP9 压缩率高但计算复杂度极大。
*   **后果**：
    *   在推流端（尤其是笔记本或低配台式机），CPU 占用率极高，可能导致系统卡顿、风扇狂转、发热降频。
    *   高分辨率（2K/4K）下帧率可能无法达标。
*   **建议**：
    *   引入 **硬件加速编码** (Hardware Acceleration)。
    *   优先检测并使用 NVIDIA (NVENC), Intel (QSV), AMD (AMF) 的硬件编码能力。
    *   或回退到 H.264 (x264/OpenH264)，虽然带宽占用稍高，但编码速度快得多，且硬件支持最广泛。

### 2.2 缺乏严格的音画同步 (AVSync)
*   **当前问题**：接收端收到视频帧和音频包后，似乎是“即收即播”，依赖网络传输的顺序。
*   **后果**：网络抖动时，声音和画面容易不同步（口型对不上，或操作声音滞后）。
*   **建议**：
    *   在发送端为每一帧视频和每一个音频包打上精确的 **PTS (Presentation Time Stamp)**。
    *   接收端建立 **Jitter Buffer (抖动缓冲区)**，根据 PTS 对齐播放时间，通常以音频时间戳为基准来同步视频渲染。

### 2.3 屏幕捕获效率
*   **当前问题**：目前的 `ScreenCapture` 实现细节未完全展开，但如果是基于 GDI 或 Qt 的 `QScreen::grabWindow`，效率较低。
*   **建议**：Windows 8 及以上系统应强制使用 **DXGI Desktop Duplication API**，这是目前 Windows 平台性能最高、延迟最低的截屏方式（直接在显存中拷贝）。

## 3. 进程管理与稳定性

### 3.1 子进程“Crash Loop”风险
*   **当前问题**：虽然增加了看门狗（Watchdog）来查杀卡死的子进程，但如果子进程因为环境问题（如缺少DLL、驱动不兼容）一启动就崩溃/卡死。
*   **后果**：看门狗会不断重启子进程，陷入死循环，导致 CPU 占用高且用户界面闪烁。
*   **建议**：增加 **重启熔断机制**。例如：如果 1 分钟内重启次数超过 3 次，则停止尝试，并弹窗提示用户“严重错误，无法启动捕获服务”。

### 3.2 资源释放的不确定性
*   **当前问题**：使用 `TerminateProcess` / `kill` 强杀子进程时，操作系统会回收内存和句柄，但某些驱动层资源（如独占的音频设备、摄像头、GPU 上下文）可能不会立即释放。
*   **后果**：重启后的新进程可能因为无法获取设备句柄而初始化失败（如“麦克风被占用”）。
*   **建议**：在启动新进程前，增加一段随机延时或检测逻辑，确保旧句柄已完全释放。

## 4. 工程化与运维

### 4.1 日志系统的局限
*   **当前问题**：依赖控制台输出 (`qDebug`) 或简单的文本日志。
*   **后果**：当用户反馈“连不上”或“黑屏”时，没有上下文日志（如网络状态、编码器错误码、SDP协商信息），难以远程排查。
*   **建议**：
    *   引入结构化日志库（如 spdlog）。
    *   实现 **日志回捞** 功能：在发生错误时，将最近 100 条关键日志打包上传到服务器。

### 4.2 硬编码配置
*   **当前问题**：代码中存在硬编码的服务器 IP (`123.207.222.92`) 和端口。
*   **建议**：完全剥离到配置文件或通过单独的“配置下发服务”获取，以便将来迁移服务器或进行灰度发布。

## 5. 产品细节体验

### 5.1 鼠标绘制的“飘移”感
*   **当前问题**：接收端直接根据收到的坐标绘制鼠标。
*   **建议**：接收端在绘制远程鼠标时，应加入 **插值平滑算法**。因为鼠标位置的采样率（如 60Hz）可能跟不上渲染率，或者受网络抖动影响，直接跳变会显得很卡。

### 5.2 分辨率适配
*   **当前问题**：发送端和接收端屏幕比例不一致时的处理策略。
*   **建议**：确保 `VideoDisplayWidget` 实现了正确的 **黑边填充 (Letterboxing)** 或 **等比缩放** 逻辑，避免画面被拉伸变形。
