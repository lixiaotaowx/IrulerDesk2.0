# 双工音频改造方案（与视频完全隔离）

- 不触碰任何视频传输相关代码与文件；音频逻辑独立实现与路由。
- 当观看者进入某个生产者的屏幕视频时，以该生产者的 `deviceId` 作为音频房间 ID。
- 音频房间复用现有路由房间 `/publish/{deviceId}` 与 `/subscribe/{deviceId}`，仅使用文本消息承载音频数据，二进制视频不受影响。

## 服务端

- 在房间路由中，订阅端发送的 `viewer_audio_opus` 消息广播给：该房间的所有订阅者（除发送者自身）以及推流端。
- 推流端发送的 `audio_opus` 保持现状：广播给所有订阅者。
- 不修改二进制视频帧转发逻辑；仅在文本消息路径上新增上述音频广播分支。

## 客户端（观看端）

- 发送端：构造 `viewer_audio_opus` 时附带 `viewer_id` 与 `target_id` 字段，用于标识音频来源与房间。
- 接收端：为每个来源维护独立 Opus 解码器与 20ms 抖动缓冲；按来源 ID 解码后在本地进行混音，写入 `QAudioSink`。
- 忽略自身 `viewer_id` 的入站音频，避免自回声。
- 统一采样率 16000、单声道 1，20ms 帧（`frame_samples=320`），本地混音按 `int16` 饱和相加。

## 客户端（生产者）

- 保持现有：接收 `viewer_audio_opus` 并解码到本地播放，使生产者可听到观看者。
- 不更改视频采集与编码路径。

## 改动点列表

- 服务端：在房间文本消息处理处增加 `viewer_audio_opus` 广播分支。
- 观看端发送：`viewer_audio_opus` 增加 `viewer_id`、`target_id`。
- 观看端接收：新增多路音频解码与混音；现有 `audio_opus` 继续作为生产者音频来源。

## 验证要点

- 进入同一房间的多名观看者与生产者互相可听见；观看端同时听到生产者与其他观看者，语音双工。
- 视频传输、解码与显示无任何改动与副作用。

## 关联文件

- 服务端：`server腾讯云服不要尝试本地构建这是上传给云的/websocket_server_with_routing.cpp`
- 观看端接收：`src/player/WebSocketReceiver.cpp`、`src/player/WebSocketReceiver.h`
- 生产者接收：`src/capture/main_capture.cpp`（已有对 `viewer_audio_opus` 的播放）

## 兼容与后续

- 若未来需要更高保真或更低延迟，可将采样率统一提升到 48k，并在混音前做重采样；本次保持 16k 以稳定为先。
