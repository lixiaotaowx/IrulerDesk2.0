# 清理日志：世界难题的可执行分步方案

本文给出一个“先快后稳、可回滚”的彻底清理日志方案，目标是：

- 彻底静默：零输出；尽量接近零计算开销。
- 可控演进：先全局静默，再逐步消除表达式开销，最后按需硬删除（物理移除）。
- 可回滚：任何阶段遇到问题可一键恢复（构建开关）。

## 阶段总览

- 阶段0（已完成）：构建级静默 + 入口处理器，立即止血（零输出）。
- 阶段1：让日志宏在禁用时“完全空操作”，避免表达式求值，逼近零开销。
- 阶段2：清理重计算日志位（JSON 序列化、复杂格式化），编译期直接屏蔽。
- 阶段3：硬删除（批量移除日志语句与相关 include），并简化/移除 LogManager。
- 每阶段均做功能验证 + 性能验证，并保留回滚路径。

---

## 阶段0：快速止血（现状）

已在 CMake 为三个目标启用：

- 编译宏：`DISABLE_ALL_LOGS`、`QT_NO_DEBUG_OUTPUT`、`QT_NO_INFO_OUTPUT`、`QT_NO_WARNING_OUTPUT`
- 三个入口安装空消息处理器：在 `src/main.cpp`、`src/capture/main_capture.cpp`、`src/player/main_player.cpp` 中，当定义 `DISABLE_ALL_LOGS` 时 `qInstallMessageHandler(noMessageHandler)` 吞掉所有 Qt 消息（包含 `qCritical/qFatal`）。

效果：无格式化、无 IO；只剩日志行中自带的表达式求值（如 JSON 序列化）。

验证建议：

- 构建：`cmake -B build -S . -DDISABLE_ALL_LOGS=ON && cmake --build build --config Release`
- 运行采集/播放/主程序，观察控制台静默且功能正常。

---

## 阶段1：宏完全空操作（逼近零开销）

目的：让 `LOG_ERROR/LOG_WARNING/LOG_INFO/LOG_DEBUG/LOG_VERBOSE` 在禁用时成为“空宏”，不执行任何函数（如 `checkFileSize()`）也不构造字符串，从而避免表达式求值。

实施：

1. 修改 `src/capture/LogManager.h`：
   - 在文件顶部增加：
     ```cpp
     #ifdef DISABLE_ALL_LOGS
     #define LOG_ERROR(category, message)
     #define LOG_WARNING(category, message)
     #define LOG_INFO(category, message)
     #define LOG_DEBUG(category, message)
     #define LOG_VERBOSE(category, message)
     // 模板 log() 在禁用时直接返回
     #endif
     ```
   - 或者用 `#ifdef` 包裹现有宏定义的非禁用分支；禁用分支置空。
2. 若存在 `LogManager::log()` 模板函数，禁用分支直接 `return;`。

验证：

- 编译后运行，确认无输出且关键路径（采集、编码、发送、接收）正常。

---

## 阶段2：屏蔽“重计算”日志位（零表达式消耗）

目的：避免日志语句内的昂贵计算被执行（如 `QJsonDocument(...).toJson()`、复杂 `QString::number(...)` 拼接）。

实施（按文件优先级）：

- 高优先级文件：
  - `src/capture/PerformanceMonitor.cpp`
  - `src/MainWindow.cpp`（登录系统大量调试）
  - `src/capture/main_capture.cpp`（演示/分析段落）
  - `src/player/main_player.cpp`
  - `src/capture/TileManager.cpp`（每帧统计）

- 操作方式：对“重计算”日志语句加编译期保护：
  ```cpp
  #ifndef DISABLE_ALL_LOGS
  qDebug() << QJsonDocument(obj).toJson(QJsonDocument::Compact);
  #endif
  ```

验证：

- 逐文件编译运行，确认功能正常、静默且 CPU 开销稳定下降或不变。

---

## 阶段3：硬删除（物理移除日志系统）

目的：在保证功能稳定的前提下，彻底移除所有日志调用与相关 `#include`，并考虑是否移除 `LogManager` 本身。

实施顺序（从安全到彻底）：

1. 标注与分组：
   - 搜索关键模式：`qDebug\(`、`qWarning\(`、`qCritical\(`、`LOG_(ERROR|WARNING|INFO|DEBUG|VERBOSE)\(`。
   - 统计每文件数量，优先从“高频噪音”文件开始（见阶段2列表）。
2. 批量注释 → 复核 → 删除：
   - 第一步先注释（便于回滚），确认功能稳定后再删除。
3. 移除相关 `#include`：
   - 删除所有 `#include <QDebug>`、`#include <QtGlobal>` 等仅为日志服务的头；若文件仍需 Qt 类型（如 `QtMsgType`），保留必要头。
4. 清理 `LogManager`：
   - 如果所有调用已删除，评估是否移除 `LogManager.h/.cpp`；或将其保留为“空实现”以便未来可恢复日志。

PowerShell 示例（辅助定位）：

```powershell
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "qDebug\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "qWarning\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "qCritical\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "LOG_(ERROR|WARNING|INFO|DEBUG|VERBOSE)\(" -CaseSensitive
```

注意：硬删除会失去现场诊断能力；建议保留构建开关 `DISABLE_ALL_LOGS` 作为兜底，必要时恢复少量关键日志位。

---

## 验证清单（每阶段）

- 功能验证：采集端能启动并编码发送，播放器能连接并解码显示；主程序 UI 与登录流程正常。
- 性能验证：采集 FPS、编码时间、发送时间、接收解码耗时，对比前后无退化。
- 静默验证：控制台与文件无日志；仅保留 UI 状态提示（如需要）。

---

## 回滚策略

- 构建开关：`-DDISABLE_ALL_LOGS=OFF` 即可恢复日志（若仍保留入口消息处理器，请调整为只过滤非致命级别或移除处理器）。
- 注释改动：硬删除前先注释，出现问题直接恢复注释内容。
- 空实现：将 `LogManager` 保留为空实现，未来需要日志时快速接回。

---

## 建议推进节奏（示例）

- 第0轮（已完成）：构建级静默 + 入口消息处理器。
- 第1轮（1天）：宏完全空操作（修改 `LogManager.h`）。
- 第2轮（1–2天）：清理高频文件的重计算日志位（加编译期保护）。
- 第3轮（1天）：全量硬删除（注释→复核→删除），移除 include，评估是否移除 `LogManager`。
- 每轮小步提交并验证，出现问题用开关兜底。

---

## 备注

- 如果你要求“绝对零开销”，优先执行阶段1和阶段2；阶段3是最终形态但风险更高。
- 若需要保留致命错误输出用于上线诊断：去掉入口的全吞消息处理器，改为只过滤 `QtDebugMsg/QtInfoMsg/QtWarningMsg`，保留 `qCritical/qFatal`。

---

## 硬删除操作清单（逐文件）

目标：直接用键盘 Backspace 物理删除，与关闭/优化无关。

### 1) 入口文件（先做，影响面广）

- `src/main.cpp`
  - 删除：`#include <QDebug>`、`#include <QtGlobal>`（如编译缺类型再恢复 `<QtGlobal>`）。
  - 删除：所有 `qDebug()` 输出行。
  - 删除：`QLoggingCategory::setFilterRules("qt.*=false")`。
  - 删除：`noMessageHandler` 定义与 `qInstallMessageHandler(noMessageHandler)` 调用。

- `src/capture/main_capture.cpp`
  - 删除：`#include <QDebug>`、`#include <QtGlobal>`（必要时保留）。
  - 删除：所有 `qDebug()` 行（包括演示/分析中的多段打印）。
  - 删除：所有 `qCritical()` 行（保留原有返回/控制流）。
  - 删除：`noMessageHandler` 与 `qInstallMessageHandler(...)`。

- `src/player/main_player.cpp`
  - 删除：`#include <QDebug>`、`#include <QtGlobal>`（必要时保留）。
  - 删除：所有 `qDebug()` 行（参数解析与模式提示）。
  - 删除：`qCritical()` 行（保留错误返回）。
  - 删除：`noMessageHandler` 与 `qInstallMessageHandler(...)`。

### 2) 高频模块（次优先）

- `src/capture/PerformanceMonitor.cpp`
  - 删除：所有统计/报告相关的 `qDebug()` 行（开始、停止、详细报告、摘要等）。
  - 删除：`#include <QDebug>`（必要时保留 `<QtGlobal>`）。

- `src/MainWindow.cpp`
  - 删除：登录系统的全部 `qDebug()`/`qWarning()` 调试与提示（连接、消息、解析、状态、重连、发送请求、列表更新等）。
  - 删除：`#include <QDebug>`。

- `src/capture/TileManager.cpp`
  - 删除：每 60 帧统计输出的 `qDebug()` 等日志行。
  - 删除：`#include <QDebug>`。

### 3) 其余目录横扫

- `src/capture/*`、`src/player/*`、`src/ui/*`、`src/video_components/*`
  - 删除：所有 `#include <QDebug>`。
  - 删除：所有 `qDebug/qWarning/qCritical` 调用行。
  - 若存在 `LOG_ERROR/LOG_WARNING/LOG_INFO/LOG_DEBUG/LOG_VERBOSE`，整行删除调用（或先改空，最终删除）。

### 4) 日志管理器收尾

- 全项目搜索确认无 `LOG_*` 与 `LogManager::` 引用后：
  - 删除：`src/capture/LogManager.h` 与 `src/capture/LogManager.cpp` 文件。
  - 删除：仅为日志存在的占位头（如 `src/NoLog.h`，若存在）。
  - 评估是否清理 `CMakeLists.txt` 中日志相关宏（`DISABLE_ALL_LOGS` / `QT_NO_*` 保留或移除均可）；移除强制包含（若曾设置）。

### 5) 构建与自测

- 构建：
  - `cmake -B build -S . && cmake --build build --config Release`
- 运行验证：
  - 采集进程：能采集/编码/发送。
  - 播放进程：能连接/接收/解码/显示。
  - 主程序：UI 与登录流程正常。

### 6) 常见编译问题的处理

- `qint64` 缺失：
  - A：恢复该文件对 `<QtGlobal>` 的包含。
  - B：改用 `long long` 或 `qsizetype`（按语义选择）。
- Qt 宏/类型缺失：
  - 恢复必要的 QtCore 相关头（很多 Qt 头会间接包含 `qglobal.h`）。

### 7) 快速定位（仅搜索，不自动改动）

```powershell
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "#include <QDebug>" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "#include <QtGlobal>" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "qDebug\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "qWarning\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "qCritical\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp, .\src\**\*.h -Pattern "LOG_(ERROR|WARNING|INFO|DEBUG|VERBOSE)\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp -Pattern "qInstallMessageHandler\(" -CaseSensitive
Select-String -Path .\src\**\*.cpp -Pattern "QLoggingCategory::setFilterRules" -CaseSensitive
```

多行日志（`<<` 链接跨行）请整段选中后删除，避免残留未删净的片段。

---

## 完成判定

- 全项目无 `#include <QDebug>` 与所有日志调用。
- 无 `LogManager` 源文件与宏调用。
- 入口无消息处理器与 Qt 过滤规则代码。
- 三大目标构建通过且运行正常，控制台完全静默。