# 在线版本更新功能实现方案

## 1. 核心思路对比

你提到的“文件夹放文件对比后缀”是可行的，但为了更稳定和规范，通常业界采用 **“版本配置文件 + 安装包”** 的方式。

### 方案 A：你的想法（文件后缀对比）

* **做法**：客户端去扫描服务器文件夹，看有没有 `App_v1.0.2.exe` 这样的文件，对比文件名里的数字。

* **缺点**：通过 HTTP 协议很难直接“列出文件夹里有哪些文件”（除非开启目录浏览权限，且解析HTML很麻烦）。

* **适用场景**：局域网共享文件夹 (SMB)，不推荐用于公网 HTTP 服务器。

### 方案 B：业界通用做法（推荐）

* **做法**：

  1. 服务器上放一个固定名字的文本文件（如 `version.json` 或 `version.txt`），里面写着最新版本号 `1.0.2`。
  2. 服务器上放最新的安装包。
  3. 客户端每次只请求这个文本文件，对比数字。如果比自己新，就去下载安装包。

* **优点**：极快（只下载几个字节）、逻辑简单、HTTP 标准支持好。

***

## 2. 推荐方案实施步骤

由于你的项目是 Qt C++ 项目，我们可以直接利用 Qt 自带的网络模块实现，无需引入复杂的第三方库。

### 第一步：服务端准备 (IP: 115.159.43.237)

假设你使用 Nginx/Apache 或其它 Web 服务，在某个目录下放置两个文件：

1. **version.json**:

   ```json
   {
       "version": "1.0.2",
       "url": "http://115.159.43.237/download/IrulerDeskPro_Setup_1.0.2.exe",
       "force": false,
       "description": "修复了局域网视频传输问题"
   }
   ```
2. **安装包文件**: `IrulerDeskPro_Setup_1.0.2.exe`

### 第二步：客户端逻辑 (ScreenStreamApp)

在 `MainWindow` 或启动流程中添加检测逻辑：

1. **检查更新**：

   * 使用 `QNetworkAccessManager` 请求 `http://115.159.43.237/download/version.json`。

   * 解析 JSON，获取 `version` 字段。

   * 将服务器版本与当前版本 (`CPACK_PACKAGE_VERSION` 或 `QCoreApplication::applicationVersion()`) 进行对比。

2. **版本号对比算法**：

   * 将字符串 "1.0.1" 拆分为数字 \[1, 0, 1] 进行逐位比较。

3. **执行更新**：

   * 如果发现新版本，弹出提示框询问用户。

   * 用户确认后，下载 `url` 对应的 `.exe` 文件到临时目录（如 `QStandardPaths::TempLocation`）。

   * 下载完成后，使用 `QProcess::startDetached` 运行安装包，并调用 `QCoreApplication::quit()` 关闭当前程序。

***

## 3. 技术细节与注意事项

* **安装包覆盖**：NSIS 安装包（你目前用的就是 NSIS）在运行时会自动处理旧文件替换。只要确保旧程序已经退出即可（所以在运行安装包后，主程序必须立刻退出）。

* **静默安装**：如果你希望全自动（用户无感知），可以在运行安装包时加参数（如 `/S`），但这通常需要管理员权限。建议还是让用户点一下“确认更新”。

* **无需额外进程**：这个逻辑直接写在 `ScreenStreamApp` 主进程里即可。

## 4. 下一步计划

如果你确认采用**方案 B**，我将为你编写具体的 C++ 更新检测类 (`AutoUpdater`)，包含：

1. `checkUpdate()` 函数：请求 version.json。
2. `downloadAndInstall()` 函数：下载并启动安装包。

